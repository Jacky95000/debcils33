{% extends 'base.html.twig' %}

{% block title %}Prendre un rendez-vous{% endblock %}

{% block stylesheets %}
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
{% endblock %}

{% block body %}
  <a href="{{ path('app_home') }}" class="back-home">← Retour à l'accueil</a>

  <h2>Prendre un rendez-vous</h2>

  {{ form_start(form, {'attr': {'id': 'rdv-form'}}) }}
    {{ form_row(form.prestation) }}

    {# Champs cachés à remplir via JS #}
    {{ form_row(form.date, {'attr': {'readonly': true, 'class': 'datepicker'}}) }}

{{ form_row(form.heure, {'attr': {'type': 'hidden'}}) }}

    <div id="calendar"></div>

    <button type="submit" class="btn">Valider</button>
  {{ form_end(form) }}

  {% if isAdmin %}
    <div class="admin-tools">
      <a href="{{ path('admin_rdv') }}" class="btn-admin">Voir les rendez-vous</a>
    </div>
  {% endif %}
{% endblock %}

{% block javascripts %}
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', async function () {
      const calendarEl = document.getElementById('calendar');

      // Récupération des créneaux déjà réservés
      const response = await fetch('{{ path("rendezvous_api_disponibilites") }}');
      const data = await response.json();

      const events = data.map(rdv => ({
        title: 'Indisponible',
        start: rdv.date + 'T' + rdv.heure,
        end: new Date(new Date('1970-01-01T' + rdv.heure).getTime() + rdv.duree * 60000).toISOString().split('T')[1].slice(0,5)
          ? `${rdv.date}T${new Date(new Date('1970-01-01T' + rdv.heure).getTime() + rdv.duree * 60000).toTimeString().slice(0,5)}`
          : null,
        display: 'background',
        backgroundColor: '#f66'
      }));

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        slotMinTime: '09:00:00',
        slotMaxTime: '18:00:00',
        slotDuration: '00:30:00',
        selectable: true,
        selectOverlap: false,
        weekends: false, // ❌ Désactiver les week-ends
        locale: 'fr',
        timeZone: 'local',
        firstDay: 1, // Lundi
        allDaySlot: false,
        events: events,

        select: function(info) {
          const date = info.startStr.split('T')[0];
          const time = info.startStr.split('T')[1].slice(0,5);

          document.querySelector('#rendez_vous_date').value = date;
          document.querySelector('#rendez_vous_heure').value = time;
          
          alert(`Créneau sélectionné : ${date} à ${time}`);
        }
      });

      calendar.render();
    });
  </script>
{% endblock %}
